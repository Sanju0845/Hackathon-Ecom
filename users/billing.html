<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing - Our Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round">
    <style>
        :root {
            --primary: #1a1a1a;
            --primary-light: #95A8E8;
            --secondary: #666;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --bg-primary: #fff;
            --bg-secondary: #f4f7ff;
            --border-color: #e5e7eb;
            --success: #22c55e;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--bg-secondary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .billing-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
        }

        .order-summary {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            height: fit-content;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .upi-section {
            margin-top: 2rem;
        }

        .upi-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .upi-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .upi-option {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upi-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .upi-option.selected {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        .upi-option img {
            width: 48px;
            height: 48px;
            margin-bottom: 0.5rem;
        }

        .upi-option span {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .upi-id {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
        }

        .upi-id span {
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .order-items {
            margin-bottom: 1.5rem;
        }

        .order-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .order-item img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 8px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .item-price {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .order-total {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .total-row.final {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .pay-button {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.2s;
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            body {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="billing-section">
            <h1>Billing Details</h1>
            <form id="billingForm">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                    <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                    <label for="address">Delivery Address</label>
                    <input type="text" id="address" required>
                    </div>
                    <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" required>
                    </div>
                    
                <div class="upi-section">
                    <h2 class="upi-title">Select Payment Method</h2>
                    <div class="upi-options">
                        <div class="upi-option" onclick="selectUpi('phonepe')">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAbFBMVEVnOrf///9iMrXKv+NeKrRmOLdYHrJkNbbw7vdgLbRbJbPGuuFhMLXc1e3IveNVF7G0o9n7+v329PqSeMng2u+7rdyYf8t9W8CAYMGnk9NtQ7l5Vr+3p9q/st6rmdXY0OuHasSMcMZHAKzRx+fRQ1l2AAACYElEQVRIia2W2ZqDIAyFBVlaKlJcaKebs7z/Ow6grUDQdpZz5Uf5K4knIQX6pYr/Bjdy118u/U5ufgDqnamUIFsrIlTV7vRLoGwVwbR4iGKiWvkU7A4MF0CYHbpVUBvFIebEldHLoKyqPOZUVXIJ7NUcGhFCkJikqs+Db2zeJBq7MLCYLNhbDgy5Yrt3Sx9pngLyAfbx3zMX0CZ9ZcH6FJQqCYi7JN62KalkDOqKJjvwu1vn6TKtdAQa+B2EC7MW6XJlQrBTgLPxOLOcgSFUF4CHnF9oYU/VgfzwwwzCX8dTfbgggHX9SUawzfjaSdjkNyBK3N5BHUZIWaBPm/z9p3sKs6v0BNaBKelpE8nZwOkUkKSewDAMfkZZhdnFZgLDen8FpHgEmyjEJTAKsvGgjPKGW9O6GLrWWLWDfRzsUpR3IT1YxwWLsTfboLAV27nkMRx/L5cdC/ZpCfhiHPw5iANLkm7oPXj5OXj5G/jro9Zg/Rk4JUemNn4KTp+jSavYg2OpiTIHTgYAjcV7EXHuSqXJgHfLgVqlY3XbZs6+UAZ8mBxkR/j9uiwblAMfZaXTIOkpMngKPgoZtg58XAHn1pFpVvg0dWwNwaBZoSNoj1Sc93W5P18ByMfTLDdkviVkK6ABooacuwK8oHPiKyDuO2sgrVAMZm+PDKi6BETX7DVAEq+yK0pBdMuR2Axfw2xJdkMQXCDt9JHjonHlqvIZuudFXVEeRB1eG5BwNJUls9zaSBbvBEPgUWWHwOP6EOhRA8dOk2ILg25p6DzoclO+NuiOamTpRutSNgsb/n2Yf6pvlrQgHh3FeJIAAAAASUVORK5CYII=" alt="PhonePe">
                            <span>PhonePe</span>
                        </div>
                        <div class="upi-option" onclick="selectUpi('paytm')">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgElEQVR4AWP4//8/IyUYwwAWvXx3IJ6JBU8H4lQgZsdrAFThfzz4MBCzkmcAAkcTa8BfIL4LxK/RDOgl1oCPUDF2IP6OJD6deAMQ4h/JMeAzECsDsSEQ/yTJAAK4lVIDnCkxYCLRCQka8ulQnAjEujB1JMYCAg8NA1yRcmAtIQMA+btEVcQPmh8AAAAASUVORK5CYII=" alt="Paytm">
                            <span>Paytm</span>
                        </div>
                        <div class="upi-option" onclick="selectUpi('fam')">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEs0lEQVR4Ab2WU5QkWRRF93sRZds1tm3btj0/o5+xbdu2bbcxaKtsZzaS8W7jfcRHKbMae60wrs6JFQoLH//2Cyf9eRAdW59alBNv2dOV0C4aUyKCZowoAIUx6E5PZUwJutUTyts/7Ht/q18544AD/XsaP7uYgFvtbrTsh8PSTOAaLbFdFSYbUKwZRNCLjUqZGNG5j87PPPrngniDt/4JL6PqP7+MrtRtnG2Dr1+6IvhdClPEWkRwuqM658ZJ+Ve+WhMaZ5S8Bssy9zgqw+t9Q+H5wdduEl0hp/CczMisH3Vb3tlFKyq/eu0H91F4pWkmeFVb9rH5Oi9Wv9fKmbM2EAPiMRRaYnvmx+p3066EdlaYnNGalgR+0KwqqD4YUrIHvUNhch0J7eQqTAmghg2sNOh08MK2IqWH1TkYcDMgfzOoOhAq94Vl7dA5kSHQK23uIuIM+8LUHNj8PCjaFnpnQN3nsKQJlAKUXy0KMkqgdBdbcfF2kJoHCCz8EGJLQDlDqtFFBIz4LULZfScVNj4dNj0blAvF20P5njDjWWj/ywZWDuRvDlUH2Gpz1wedChgA6JgAjd+DAGLwUWCFgE1AzOB5x2PQ9BPkrA81BwFA3sawy80w8VYI1sGmZ0LtYZBR7HcNIB6Glt9g5vMQ6rFjQwbHEIOLsR0YjAf982HqfbYbVfsBAoE6yKqEbS6Hwq0AWwDKAS8EnVOg/muI9EM8gq1eGBrBtVYxDI2CZT0w730o2xUiA9DwA2x2BuRtiB2DBhOFrsnQ/Ivdrz0Ucmph3HVgvBGF63dgWBT0zISBhTCwACr28IOD7VLbOHu8wdFQuLm13bz3INAIokbogGGwCIciHICWP+0oag/xO2ZiVuG1B0N2NTgpEFsGDd/DjJfBiw3vcKVARh2B3yrqv4ctzrLWtPeDToHSnUBpO57mqVD3JbRNgOhiX3zDvZOERgAgEGyC9CL7UjGAsvuhHtudRV9B138QX4r1vK1wRJTxbTgqxrMtB2zFQWj8GeZ9CD2zwIuCdgANtrrE/hIwQkJLPAqd022yffNgxis2iehSazc0GEl6sRpIJGMBGn6Bsp1hYBFsdAzkrQ+tE6BnDmhFcijwO2BGz1aAYCtMeRxqD4DCTe2sM0v955NazKpFI0LCizHW222TwMTtzAs28ec+hsXFZkLCxCIw+Qlw0mGrM6B0O2vNSABQJIUS/0OUFOEBGHevDbrlaVC+E9T9CMolKbS1oYcIkGwSQZjwMAw0wnoHQNs0CPWBUiSGQox4rojuwoiAKJLDWnPGO1C0ua1eJJk6jDi6y43rjCmp0h9USB5jpXs2oECphDspqEBcZUzVA5mbjzcqZRLGMOZF8F2S4GKUO64/a/PJuqruy76wW/CYoLsRYV0sgu6IOPmPV7d8FXDOvfAsFlSfU1/WP6nf8cK7K/Gy1m5wpzPiFtzw13bPfqE0ogDqXjmN/uzNnM2a3zw4Pdp7tTaRPRSSC74wEUDB2I6VCCpgdNq4SGrhY3PWv+T3osD/3gYXfejf8vqESZz36G60HXhIQd7Shbu58SU7KfFKAcXYUYAnyumKu1lTg1kbT66Y+fPAS2dP49I9dgJgOYEsXs0SYzh3AAAAAElFTkSuQmCC" alt="FamPay">
                            <span>FamPay</span>
                        </div>
                    </div>
                    <div class="upi-id">
                        <p>UPI ID: <span>9493562061@fam</span></p>
                    </div>
                </div>
            </form>
        </div>

        <div class="order-summary">
            <h1>Order Summary</h1>
            <div class="order-items" id="orderItems">
                <!-- Order items will be added here dynamically -->
            </div>
            <div class="order-total">
                <div class="total-row">
                    <span>Subtotal</span>
                    <span id="subtotal">₹0.00</span>
                </div>
                <div class="total-row">
                    <span>Shipping</span>
                    <span>Free</span>
                </div>
                <div class="total-row final">
                    <span>Total</span>
                    <span id="total">₹0.00</span>
                </div>
            </div>
            <button class="pay-button" onclick="processPayment()">Pay Now</button>
        </div>
    </div>

    <script>
        // Get checkout data from localStorage
        const checkoutData = JSON.parse(localStorage.getItem('checkout_data') || '{}');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
        let selectedUpi = null;  // Initialize selectedUpi at the top level
            
        // Populate user data
        document.getElementById('name').value = user.name || '';
        document.getElementById('address').value = user.address || '';
        document.getElementById('phone').value = user.phone || '';

        // Display order items
                const orderItems = document.getElementById('orderItems');
        const subtotal = document.getElementById('subtotal');
        const total = document.getElementById('total');

        if (checkoutData.items && checkoutData.items.length > 0) {
            orderItems.innerHTML = checkoutData.items.map(item => `
                        <div class="order-item">
                    <img src="${item.products?.image_url || 'https://via.placeholder.com/64'}" 
                         alt="${item.products?.name || 'Product'}"
                         onerror="this.src='https://via.placeholder.com/64'">
                            <div class="item-details">
                        <div class="item-name">${item.products?.name || 'Product'}</div>
                        <div class="item-price">
                            ₹${parseFloat(item.products?.price || 0).toFixed(2)} × ${item.quantity}
                        </div>
                    </div>
                    </div>
            `).join('');

            subtotal.textContent = `₹${checkoutData.total.toFixed(2)}`;
            total.textContent = `₹${checkoutData.total.toFixed(2)}`;
        }

        function selectUpi(upi) {
            selectedUpi = upi;
            document.querySelectorAll('.upi-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            if (upi === 'fam') {
                // Open FamPay app
                const amount = checkoutData.total;
                const upiUrl = `upi://pay?pa=9493562061@fam&pn=OurStore&am=${amount}&cu=INR&tn=Order Payment`;
                window.location.href = upiUrl;
            } else {
                // Show demo message for other UPI options
                alert('This is a demo mode. In a real app, this would open the ' + upi.toUpperCase() + ' app.');
            }
        }

        async function processPayment() {
            // If no UPI selected, use a default one
            if (!selectedUpi) {
                selectedUpi = 'fam';
            }

            // Validate required fields
            const name = document.getElementById('name').value;
            const address = document.getElementById('address').value;
            const phone = document.getElementById('phone').value;

            if (!name || !address || !phone) {
                alert('Please fill in all required fields');
                return;
            }

            const formData = {
                name: name,
                address: address,
                phone: phone,
                payment_method: selectedUpi,
                upi_id: '9493562061@fam',
                items: checkoutData.items.map(item => ({
                    product_id: item.products.id,
                    quantity: item.quantity,
                    price: item.products.price
                })),
                total: checkoutData.total,
                user_id: user.id
            };

            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to process payment');
                }
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    text-align: center;
                    z-index: 1000;
                `;
                successMessage.innerHTML = `
                    <h2 style="color: #22c55e; margin-bottom: 1rem;">Order Placed Successfully!</h2>
                    <p style="margin-bottom: 0.5rem;">Thank you for your order.</p>
                    <p style="color: #666; margin-bottom: 1rem;">Order ID: ${data.order_id}</p>
                    <p style="color: #666; margin-bottom: 1rem;">Payment Method: ${selectedUpi.toUpperCase()}</p>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">(Demo Mode)</p>
                    <button onclick="window.location.href='orders.html'" 
                            style="background: #1a1a1a; color: white; border: none; padding: 0.75rem 1.5rem; 
                                   border-radius: 8px; cursor: pointer;">
                        View Orders
                    </button>
                `;
                document.body.appendChild(successMessage);

                // Clear checkout data
                localStorage.removeItem('checkout_data');
            } catch (error) {
                console.error('Payment error:', error);
                alert(error.message || 'Failed to process payment. Please try again.');
            }
        }
    </script>
</body>
</html> 